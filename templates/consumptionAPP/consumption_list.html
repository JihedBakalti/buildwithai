{% extends "base.html" %}
{% load static %}

{% block content %}

<style>
    .alerts-box a {
    text-decoration: none;
    color: inherit;
    }

    .alerts-box a:hover {
            text-decoration: underline;
    }

    .alerts-box {
        margin-top: 20px;
        padding: 12px 16px;
        border-radius: 6px;
        background: #fff5f5;
        border: 1px solid #f0b2b2;
        font-size: 14px;
    }

    .alerts-box h3 {
        margin-top: 0;
        margin-bottom: 8px;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .alerts-box ul {
        margin: 0;
        padding-left: 18px;
    }

    .water-card {
        background: #f7fbff;
        border: 1px solid #d0d7e2;
        border-radius: 8px;
        padding: 20px 24px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .water-card h2 {
        margin-top: 0;
        margin-bottom: 16px;
        font-size: 22px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .filter-bar {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
        margin-bottom: 18px;
        font-size: 14px;
    }

    .filter-bar label {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .filter-bar input[type="month"] {
        padding: 4px 6px;
        border-radius: 4px;
        border: 1px solid #b8c1d1;
        min-width: 165px;
    }

    .filter-bar button[type="submit"] {
        padding: 5px 12px;
        border-radius: 4px;
        border: 1px solid #adb5bd;
        background: #f4f6fb;
        cursor: pointer;
    }

    .filter-bar button[type="submit"]:hover {
        background: #e2e6f3;
    }

    .filter-bar a {
        text-decoration: underline;
        color: #4b2aa7;
        cursor: pointer;
    }

    table.table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    table.table thead {
        background: #e9f1ff;
    }

    table.table th,
    table.table td {
        padding: 8px 10px;
        border: 1px solid #dde2ec;
        text-align: left;
        white-space: nowrap;
    }

    table.table tfoot th {
        background: #f0f5ff;
    }

    .status-ok {
        font-weight: 600;
    }

    .status-depasse {
        font-weight: 600;
        color: #c30000;
    }
</style>

<div class="container">
    <main class="main-content">
        <div class="water-card">
            <h2>üíß Water Consumption Records</h2>

            {# --- FILTRE MOIS UNIQUEMENT EN MODE D√âTAIL --- #}
            {% if detail_mode %}
                <form method="get" class="filter-bar">
                    <label>
                        Mois :
                        <input type="month" name="month" value="{{ selected_month }}">
                    </label>

                    {# garder la ferme dans la requ√™te quand on change de mois #}
                    {% if selected_farm %}
                        <input type="hidden" name="farm" value="{{ selected_farm }}">
                    {% endif %}

                    <button type="submit">Filtrer</button>

                    <a href="{% url 'consumption_list' %}?farm={{ selected_farm }}">
                        R√©initialiser
                    </a>
                </form>
            {% endif %}

            {# --- MODE GLOBAL : une ligne par ferme --- #}
            {% if not detail_mode %}
                <table class="table mt-3">
                    <thead>
                        <tr>
                            <th>Ferme</th>
                            <th>D√©tails</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for a in farm_rows %}
                            <tr>
                                <td>Ferme {{ a.farm }}</td>
                                <td>
                                    <a href="{% url 'consumption_list' %}?farm={{ a.farm }}">
                                        Voir les enregistrements
                                    </a>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="2">Aucune consommation enregistr√©e.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>

                {# ===== BLOC ALERTES DEPASSEMENT ===== #}
                <div class="alerts-box">
                    <h3>‚ö†Ô∏è Alertes de d√©passement de quota</h3>

                    {% if alerts %}
                        <ul>
                            {% for al in alerts %}
                                <li>
                                    <a href="{% url 'consumption_list' %}?farm={{ al.farm }}&month={{ al.month|date:'Y-m' }}">
                                        Ferme {{ al.farm }} ‚Äî 
                                        {{ al.month|date:"Y-m" }} :
                                        consomm√© {{ al.total_volume|floatformat:2 }} L /
                                        quota {{ al.quota_ref|floatformat:2 }} L
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>Aucun d√©passement de quota d√©tect√© pour le moment.</p>
                    {% endif %}
                </div>



            {# --- MODE D√âTAIL : dates / volumes pour une ferme --- #}
            {% else %}

                <h3>
                    Ferme {{ selected_farm }}
                    {% if selected_month %} ‚Äì {{ selected_month }}{% endif %}
                </h3>

                <table class="table mt-3">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Volume utilis√© (L)</th>
                            <th>Quota attribu√© (L)</th>
                            <th>Ferme</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in consommations %}
                            <tr>
                                <td>{{ c.date }}</td>
                                <td>{{ c.volume_utilise|floatformat:2 }}</td>
                                <td>{{ c.quota_attribue|floatformat:2 }}</td>
                                <td>Ferme {{ c.farm }}</td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="4">Aucune consommation pour cette ferme.</td>
                            </tr>
                        {% endfor %}
                    </tbody>

                    <tfoot>
                        {% if show_totals %}
                            <tr>
                                <th>Total</th>
                                <th>{{ total_volume|floatformat:2 }}</th>
                                <th>{{ total_quota|floatformat:2 }}</th>
                                <th>
                                    Ferme {{ total_farm }}
                                    {% if total_status == "ok" %}
                                        ‚Äî ‚úÖ OK
                                    {% elif total_status == "depasse" %}
                                        ‚Äî ‚ö†Ô∏è D√©pass√©
                                    {% endif %}
                                </th>
                            </tr>
                        {% endif %}
                    </tfoot>
                </table>

                <p>
                    <a href="{% url 'consumption_list' %}">
                        ‚¨ÖÔ∏è Retour √† la vue globale
                    </a>
                </p>

            {% endif %}

        </div>
    </main>
</div>
{% endblock %}
