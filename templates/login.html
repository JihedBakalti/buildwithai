{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/style.css' %}">
<link rel="stylesheet" href="{% static 'vendor/aos/aos.css' %}">

<div class="container">
    <main class="main-content">
        <div class="form-container" data-aos="fade-up">
            <!-- Modern hero-style title -->
            <h2 class="text-center hero-title" style="color: #00a19e;">Login</h2>

            <form method="post" class="form-modern">
                {% csrf_token %}

                <!-- Non-field (global) errors -->
                {% if form.non_field_errors %}
                    <div class="alert alert-danger mb-3">
                        {% for error in form.non_field_errors %}
                            <p>‚ö†Ô∏è {{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}

                <!-- Field-specific errors -->
                {% for field in form %}
                    {% if field.errors %}
                        <div class="alert alert-danger mb-2">
                            {% for error in field.errors %}
                                <p><strong>{{ field.label }}:</strong> {{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endfor %}

                <div class="form-group">
                    <label>Username</label>
                    <input type="text" name="username" class="form-input" placeholder="Enter your username" value="{{ form.username.value|default_if_none:'' }}">
                </div>

                <div class="form-group">
                    <label>Password</label>
                    <input type="password" name="password" class="form-input" placeholder="Enter your password">
                </div>

                <!-- Centered gradient button -->
                <div class="text-center mt-1">
                    <button type="submit" class="btn btn-gradient btn-large">Login</button>
                </div>
            </form>

            <!-- QR Code Authentication -->
            <div class="text-center mt-3">
                <div class="divider">
                    <span>OR</span>
                </div>
                <button type="button" class="btn btn-outline-primary btn-large mt-3" id="qrAuthBtn" onclick="startQRScan()">
                    üì∑ Quick QR Auth
                </button>
            </div>

            <!-- QR Scanner Modal -->
            <div id="qrScannerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 90%;">
                    <div style="text-align: center;">
                        <h3 style="margin-bottom: 20px;">Scan QR Code</h3>
                        <video id="qrVideo" autoplay playsinline style="width: 100%; max-width: 400px; border: 2px solid #ddd; border-radius: 5px;"></video>
                        <canvas id="qrCanvas" style="display: none;"></canvas>
                        <div id="qrStatus" style="margin-top: 15px; color: #666;"></div>
                        <div style="margin-top: 20px;">
                            <button type="button" class="btn btn-secondary" onclick="stopQRScan()">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <p class="text-center mt-4 sub-text">
                Don't have an account? <a href="{% url 'inscription' %}" class="nav-link">Sign Up</a>
            </p>
        </div>
    </main>
</div>

<!-- jsQR Library -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script src="{% static 'vendor/aos/aos.js' %}"></script>
<script>
    AOS.init();
    
    let qrStream = null;
    let qrScanInterval = null;
    
    function startQRScan() {
        const modal = document.getElementById('qrScannerModal');
        const video = document.getElementById('qrVideo');
        const canvas = document.getElementById('qrCanvas');
        const status = document.getElementById('qrStatus');
        
        modal.style.display = 'block';
        status.textContent = 'Requesting camera access...';
        
        // Request camera access
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment' // Use back camera on mobile
            } 
        })
        .then(function(stream) {
            qrStream = stream;
            video.srcObject = stream;
            video.setAttribute('playsinline', true);
            video.play();
            
            status.textContent = 'Point camera at QR code...';
            
            // Start scanning
            qrScanInterval = setInterval(function() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.height = video.videoHeight;
                    canvas.width = video.videoWidth;
                    const context = canvas.getContext('2d');
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code) {
                        // QR code detected
                        status.textContent = 'QR code detected! Authenticating...';
                        authenticateQRCode(code.data);
                    }
                }
            }, 100);
        })
        .catch(function(err) {
            console.error('Error accessing camera:', err);
            status.textContent = 'Error: Could not access camera. Please allow camera permissions.';
            status.style.color = '#dc2626';
        });
    }
    
    function stopQRScan() {
        const modal = document.getElementById('qrScannerModal');
        const video = document.getElementById('qrVideo');
        
        // Stop video stream
        if (qrStream) {
            qrStream.getTracks().forEach(track => track.stop());
            qrStream = null;
        }
        
        // Stop scanning interval
        if (qrScanInterval) {
            clearInterval(qrScanInterval);
            qrScanInterval = null;
        }
        
        // Hide modal
        modal.style.display = 'none';
        video.srcObject = null;
        
        // Reset status
        document.getElementById('qrStatus').textContent = '';
    }
    
    function authenticateQRCode(hash) {
        const status = document.getElementById('qrStatus');
        status.textContent = 'Authenticating...';
        
        // Get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        const csrftoken = getCookie('csrftoken');
        
        // Send hash to server
        fetch('{% url "qr_auth_login" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ hash: hash })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                status.textContent = 'Login successful! Redirecting...';
                status.style.color = '#16a34a';
                
                // Stop scanning
                stopQRScan();
                
                // Redirect to home
                setTimeout(function() {
                    window.location.href = data.redirect_url || '/home/';
                }, 500);
            } else {
                status.textContent = 'Error: ' + data.message;
                status.style.color = '#dc2626';
                
                // Continue scanning after error
                setTimeout(function() {
                    status.textContent = 'Point camera at QR code...';
                    status.style.color = '#666';
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            status.textContent = 'Error: Could not authenticate. Please try again.';
            status.style.color = '#dc2626';
            
            // Continue scanning after error
            setTimeout(function() {
                status.textContent = 'Point camera at QR code...';
                status.style.color = '#666';
            }, 2000);
        });
    }
    
    // Close modal when clicking outside
    document.getElementById('qrScannerModal').addEventListener('click', function(e) {
        if (e.target === this) {
            stopQRScan();
        }
    });
</script>
{% endblock %}
